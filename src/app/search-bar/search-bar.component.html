<div
  class="container p-4 sm:p-6 border border-slate-300 rounded-2xl"
  [formGroup]="searchForm"
>
  <!-- Header avec icône et titre -->
  <div class="flex flex-row gap-x-2 items-center mb-4 sm:mb-6">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 18 18"
      fill="none"
      class="flex-shrink-0"
    >
      <path
        d="M15.75 15.75L12.4875 12.4875M14.25 8.25C14.25 11.5637 11.5637 14.25 8.25 14.25C4.93629 14.25 2.25 11.5637 2.25 8.25C2.25 4.93629 4.93629 2.25 8.25 2.25C11.5637 2.25 14.25 4.93629 14.25 8.25Z"
        stroke="black"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
    <span class="text-base sm:text-lg font-medium">{{ 'search.1' | translate }}</span>
  </div>

  <!-- Section Type (Achat/Location) -->
  <div class="mb-4 sm:mb-6">
    <span class="text-sm sm:text-base font-medium text-gray-700 block mb-3">{{ 'search.2' | translate }}</span>
    <div class="flex flex-row w-full md:w-auto md:inline-flex">
      <div *ngFor="let type of types; let first = first; let last = last" class="flex-1 md:flex-none">
        <span
          class="block py-2 sm:py-4 px-3 sm:px-4 md:px-6 lg:px-8 text-sm sm:text-base border cursor-pointer text-center transition-all duration-200 hover:bg-gray-50 whitespace-nowrap"
          [class.bg-blue-50]="type.active"
          [class.border-blue-500]="type.active"
          [class.text-blue-700]="type.active"
          [class.bg-gray-200]="!type.active"
          [class.border-gray-300]="!type.active"
          [class.text-gray-700]="!type.active"
          [class.rounded-l-xl]="first"
          [class.rounded-r-xl]="last"
          [class.border-r-0]="!last"
          (click)="selectType(type.id)"
          >{{ type.id === 'sale' ? ('search.3' | translate) : ('search.4' | translate) }}
        </span>
      </div>
    </div>
  </div>

  <!-- Grille principale des filtres - responsive -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-4 lg:gap-6">
    
    <!-- Lieu -->
    <div class="relative order-1">
      <label class="text-sm sm:text-base font-medium text-gray-700 block mb-2">{{ 'search.5' | translate }}</label>
      <div class="relative">
        <input
          type="text"
          formControlName="location"
          class="w-full py-3 sm:py-2 px-3 sm:px-3 bg-gray-100 rounded-lg pr-10 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"
          [placeholder]="getSelectedLocationsText()"
          (input)="onLocationInput($event)"
          (focus)="toggleLocationDropdown()"
          readonly
        />
        <svg
          class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 sm:w-5 sm:h-5 text-gray-500 cursor-pointer transition-transform duration-200"
          [class.rotate-180]="isLocationDropdownOpen"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          (click)="toggleLocationDropdown()"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"
          ></path>
        </svg>
      </div>

      <!-- Dropdown des codes postaux groupés par province -->
      <div
        *ngIf="isLocationDropdownOpen && filteredProvinces.length > 0"
        class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 sm:max-h-80 overflow-y-auto z-20 min-w-full w-auto"
      >
        <div *ngFor="let provinceGroup of filteredProvinces">
          <!-- Titre de la province -->
          <div
            class="px-3 py-2 bg-gray-50 border-b border-gray-200 text-xs sm:text-sm font-semibold text-gray-700 sticky top-0"
          >
            {{ provinceGroup.province }}
          </div>

          <!-- Codes postaux de cette province -->
          <div
            *ngFor="let zipOption of provinceGroup.zipOptions"
            class="px-3 py-3 sm:py-2 pl-6 hover:bg-gray-100 cursor-pointer text-xs sm:text-sm border-b border-gray-100 last:border-b-0 flex items-center"
            (click)="toggleLocationSelection(zipOption)"
          >
            <input
              type="checkbox"
              [checked]="isLocationSelected(zipOption.displayText)"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-3 flex-shrink-0"
              (click)="$event.stopPropagation()"
              (change)="toggleLocationSelection(zipOption)"
            />
            <div class="flex-1 min-w-0">
              <span class="font-medium">{{ zipOption.zip }}</span>
              <span class="text-gray-600 ml-2 truncate">{{ zipOption.localite }}</span>
              <span class="text-blue-600 ml-2 flex-shrink-0">({{ zipOption.count }})</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message si aucun résultat -->
      <div
        *ngIf="isLocationDropdownOpen && filteredProvinces.length === 0"
        class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl p-3 z-20 min-w-full w-auto"
      >
        <span class="text-gray-500 text-xs sm:text-sm">{{ 'search.7' | translate }}</span>
      </div>
    </div>

    <!-- Type de bien -->
    <div class="order-2">
      <label class="text-sm sm:text-base font-medium text-gray-700 block mb-2">{{ 'search.8' | translate }}</label>
      <select
        formControlName="propertyType"
        class="w-full py-3 sm:py-2 px-3 bg-gray-100 rounded-lg appearance-none cursor-pointer text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"
        (change)="onPropertyTypeChange()"
      >
        <option value="">{{ 'search.9' | translate }}</option>
        <option
          *ngFor="let propertyType of propertyTypes"
          [value]="propertyType.id"
        >
          {{ propertyType.name | translate }} ({{ propertyType.count }})
        </option>
      </select>
    </div>

    <!-- Nombre de chambres -->
    <div class="relative order-3">
      <label class="text-sm sm:text-base font-medium text-gray-700 block mb-2">{{ 'search.10' | translate }}</label>
      <div
        class="w-full py-3 sm:py-2 px-3 bg-gray-100 rounded-lg cursor-pointer flex items-center justify-between focus-within:ring-2 focus-within:ring-blue-500 focus-within:bg-white transition-all"
        (click)="toggleRoomsDropdown()"
      >
        <span class="text-gray-700 text-sm sm:text-base truncate">{{ getRoomsDisplayText() }}</span>
        <svg
          class="w-4 h-4 sm:w-5 sm:h-5 transition-transform duration-200 flex-shrink-0 ml-2"
          [class.rotate-180]="isRoomsDropdownOpen"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"
          ></path>
        </svg>
      </div>

      <!-- Mini fenêtre chambres -->
      <div
        *ngIf="isRoomsDropdownOpen"
        class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl p-4 sm:p-6 z-10"
      >
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
          <div
            *ngFor="let room of availableRoomOptions"
            class="py-3 sm:py-2 px-3 text-sm sm:text-base border rounded-lg cursor-pointer text-center transition-all duration-200 hover:bg-gray-50 touch-manipulation"
            [class.bg-blue-50]="isRoomSelected(room.value)"
            [class.border-blue-500]="isRoomSelected(room.value)"
            [class.text-blue-700]="isRoomSelected(room.value)"
            [class.border-gray-300]="!isRoomSelected(room.value)"
            [class.text-gray-700]="!isRoomSelected(room.value)"
            (click)="toggleRoomSelection(room.value)"
          >
            {{ room.label }}
          </div>
        </div>
        <div class="flex justify-end mt-4">
          <button
            class="text-sm sm:text-base text-white px-4 sm:px-6 py-2 rounded-lg hover:opacity-90 transition-opacity touch-manipulation"
            style="background-color: #233353"
            (click)="closeRoomsDropdown()"
          >
            {{ 'search.21' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Prix -->
    <div class="relative order-4">
      <label class="text-sm sm:text-base font-medium text-gray-700 block mb-2">{{ 'search.14' | translate }}</label>
      <div
        class="w-full py-3 sm:py-2 px-3 bg-gray-100 rounded-lg cursor-pointer flex items-center justify-between focus-within:ring-2 focus-within:ring-blue-500 focus-within:bg-white transition-all"
        (click)="togglePriceDropdown()"
      >
        <span class="text-gray-700 text-sm sm:text-base truncate">{{ getPriceDisplayText() }}</span>
        <svg
          class="w-4 h-4 sm:w-5 sm:h-5 transition-transform duration-200 flex-shrink-0 ml-2"
          [class.rotate-180]="isPriceDropdownOpen"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7"
          ></path>
        </svg>
      </div>

      <!-- Mini fenêtre prix -->
      <div
        *ngIf="isPriceDropdownOpen"
        class="absolute top-full left-0 right-0 sm:left-auto sm:right-0 sm:w-96 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl p-4 sm:p-6 z-10"
      >
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-xs sm:text-sm text-gray-600 mb-2 block font-medium">{{ 'search.15' | translate }}</label>
            <input
              type="number"
              class="w-full py-3 sm:py-2 px-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              [placeholder]="
                suggestedMinPrice ? suggestedMinPrice.toString() : ('search.17' | translate)
              "
              formControlName="minPrice"
            />
          </div>
          <div>
            <label class="text-xs sm:text-sm text-gray-600 mb-2 block font-medium">{{ 'search.16' | translate }}</label>
            <input
              type="number"
              class="w-full py-3 sm:py-2 px-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              [placeholder]="
                suggestedMaxPrice ? suggestedMaxPrice.toString() : ('search.18' | translate)
              "
              formControlName="maxPrice"
            />
          </div>
        </div>
        <div class="flex justify-end mt-4">
          <button
            class="text-sm sm:text-base text-white px-4 sm:px-6 py-2 rounded-lg hover:opacity-90 transition-opacity touch-manipulation"
            style="background-color: #233353"
            (click)="closePriceDropdown()"
          >
            {{ 'search.21' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section des filtres avancés - visible uniquement si activée -->
  <div *ngIf="isAdvancedFiltersOpen" class="mt-6 border-t border-gray-200 pt-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-4 lg:gap-6 mb-4">
      
      <!-- Filtres checkbox -->
      <div class="space-y-3">
        <label class="text-sm sm:text-base font-medium text-gray-700 block">Options spéciales</label>
        
        <label class="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            formControlName="showUnderOption"
            (change)="onAdvancedFilterChange()"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <span class="text-sm text-gray-700">Afficher les biens sous option</span>
        </label>
        
        <label class="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            formControlName="showWithTerrace"
            (change)="onAdvancedFilterChange()"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <span class="text-sm text-gray-700">Avec terrasse</span>
        </label>
        
        <label class="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            formControlName="showWithGarden"
            (change)="onAdvancedFilterChange()"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <span class="text-sm text-gray-700">Avec jardin</span>
        </label>
        
        <label class="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            formControlName="showWithGarage"
            (change)="onAdvancedFilterChange()"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <span class="text-sm text-gray-700">Avec garage</span>
        </label>
      </div>

      <!-- Surface -->
      <div>
        <label class="text-sm sm:text-base font-medium text-gray-700 block mb-2">Surface</label>
        <div class="relative">
          <div
            class="w-full py-3 sm:py-2 px-3 bg-gray-100 rounded-lg cursor-pointer flex items-center justify-between focus-within:ring-2 focus-within:ring-blue-500 focus-within:bg-white transition-all"
            (click)="toggleSurfaceDropdown()"
          >
            <span class="text-gray-700 text-sm sm:text-base truncate">{{ getSurfaceDisplayText() }}</span>
            <svg
              class="w-4 h-4 sm:w-5 sm:h-5 transition-transform duration-200 flex-shrink-0 ml-2"
              [class.rotate-180]="isSurfaceDropdownOpen"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </div>

          <!-- Mini fenêtre surface -->
          <div
            *ngIf="isSurfaceDropdownOpen"
            class="absolute top-full left-0 right-0 sm:left-auto sm:right-0 sm:w-96 mt-0 bg-white border border-gray-200 rounded-lg shadow-xl p-4 sm:p-6 z-10"
          >
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs sm:text-sm text-gray-600 mb-2 block font-medium">Surface min</label>
              <input
                type="number"
                class="w-full py-3 sm:py-2 px-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                placeholder="Min m²"
                formControlName="minSurface"
              />
            </div>
            <div>
              <label class="text-xs sm:text-sm text-gray-600 mb-2 block font-medium">Surface max</label>
              <input
                type="number"
                class="w-full py-3 sm:py-2 px-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                placeholder="Max m²"
                formControlName="maxSurface"
              />
            </div>
          </div>
          <div class="flex justify-end mt-4">
            <button
              class="text-sm sm:text-base text-white px-4 sm:px-6 py-2 rounded-lg hover:opacity-90 transition-opacity touch-manipulation"
              style="background-color: #233353"
              (click)="closeSurfaceDropdown()"
            >
              {{ 'search.21' | translate }}
            </button>
          </div>
          </div>
        </div>
      </div>

      <!-- Année de construction -->
      <div>
        <label class="text-sm sm:text-base font-medium text-gray-700 block mb-2">Année de construction</label>
        <div class="relative">
          <div
            class="w-full py-3 sm:py-2 px-3 bg-gray-100 rounded-lg cursor-pointer flex items-center justify-between focus-within:ring-2 focus-within:ring-blue-500 focus-within:bg-white transition-all"
            (click)="toggleConstructionYearDropdown()"
          >
            <span class="text-gray-700 text-sm sm:text-base truncate">{{ getConstructionYearDisplayText() }}</span>
            <svg
              class="w-4 h-4 sm:w-5 sm:h-5 transition-transform duration-200 flex-shrink-0 ml-2"
              [class.rotate-180]="isConstructionYearDropdownOpen"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </div>

          <!-- Mini fenêtre année de construction -->
          <div
            *ngIf="isConstructionYearDropdownOpen"
            class="absolute top-full left-0 right-0 sm:left-auto sm:right-0 sm:w-96 mt-0 bg-white border border-gray-200 rounded-lg shadow-xl p-4 sm:p-6 z-10"
          >
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs sm:text-sm text-gray-600 mb-2 block font-medium">Année min</label>
              <input
                type="number"
                class="w-full py-3 sm:py-2 px-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                placeholder="Ex: 1990"
                formControlName="minConstructionYear"
              />
            </div>
            <div>
              <label class="text-xs sm:text-sm text-gray-600 mb-2 block font-medium">Année max</label>
              <input
                type="number"
                class="w-full py-3 sm:py-2 px-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                placeholder="Ex: 2023"
                formControlName="maxConstructionYear"
              />
            </div>
          </div>
          <div class="flex justify-end mt-4">
            <button
              class="text-sm sm:text-base text-white px-4 sm:px-6 py-2 rounded-lg hover:opacity-90 transition-opacity touch-manipulation"
              style="background-color: #233353"
              (click)="closeConstructionYearDropdown()"
            >
              {{ 'search.21' | translate }}
            </button>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Boutons d'action - responsive -->
  <div class="mt-6 sm:mt-8 flex flex-col sm:flex-row justify-end gap-3 sm:gap-3">
    <button
      type="button"
      class="w-full sm:w-auto px-4 sm:px-6 py-2 sm:py-2 text-sm sm:text-base text-blue-600 border border-blue-500 rounded-lg hover:bg-blue-50 transition-all touch-manipulation order-3 sm:order-1"
      (click)="toggleAdvancedFilters()"
    >
      {{ isAdvancedFiltersOpen ? 'Masquer filtres avancés' : 'Filtres avancés' }}
    </button>
    <button
      type="button"
      class="w-full sm:w-auto px-4 sm:px-6 py-2 sm:py-2 text-sm sm:text-base text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all touch-manipulation order-2 sm:order-2"
      (click)="clearSearch()"
    >
      {{ 'search.22' | translate }}
    </button>
    <!-- Bouton Rechercher visible uniquement sur mobile/tablette -->
    <button
      type="button"
      class="w-full sm:w-auto lg:hidden px-4 sm:px-6 py-2 sm:py-2 text-sm sm:text-base text-white rounded-lg hover:opacity-90 transition-opacity touch-manipulation order-1 sm:order-3"
      style="background-color: #233353"
      (click)="onSearchAndScroll()"
    >
      {{ 'search.23' | translate }}
    </button>
  </div>
</div>

<!-- Click outside to close dropdown -->
<div
  *ngIf="isLocationDropdownOpen"
  class="fixed inset-0 z-10"
  (click)="closeLocationDropdown()"
></div>
